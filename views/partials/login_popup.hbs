<script language="JavaScript" type="text/javascript">

   function submitLogin(formElementId, emailElementId, passwordElementId, messagesElementId) {
      var messages = new com.cattfish.Messages();
      var messagesElement = $("#" + messagesElementId);
      var form = $("#" + formElementId);
      var emailElement = $("#" + emailElementId);
      var passwordElement = $("#" + passwordElementId);
      var email = emailElement.val().trim();
      var password = passwordElement.val();

      messagesElement.empty().hide();

      var user = {
         email : email,
         password : password
      };

      // perform simple validation
      if (user.password.length <= 0) {
         messages.add("Password is required.");
         passwordElement.focus();
      }
      if (user.email.length <= 0) {
         messages.add("Email address is required.");
         emailElement.focus();
      }

      if (messages.isEmpty()) {
         setFormEnabled(form, false);
         superagent
               .post("/login")
               .send(user)
               .end(function(err, res) {
                       setFormEnabled(form, true);
                       console.log(JSON.stringify(res.body, null, 3));
                       if (res.status == 200) {
                          var redirectToAfterLogin = '{{{redirectToAfterLogin}}}';
                          if (redirectToAfterLogin && redirectToAfterLogin.length > 0) {
                             window.location.href = redirectToAfterLogin;
                          }
                          else {
                             window.location.href = '/';
                          }
                       }
                       else if (res.status == 401) {
                          messages.add("Login failed. Please double-check your login below and make sure you have " +
                                       "activated your account by clicking the link in the verification email we sent " +
                                       "when you signed up.");
                       }
                       else {
                          messages.add("Login failed.");
                       }
                       emailElement.focus();
                       messages.render(messagesElement);
                    });
      }
      else {
         messages.render(messagesElement);
      }

      return false;
   }
</script>
<div id="login_popup">
   <form id="login_popup_form" onsubmit="return submitLogin('login_popup_form','login_popup_email','login_popup_password','login_popup_messages');">

      <div id="login_popup_messages" class="form_messages form_error_messages"></div>
      <div><input type="text" id="login_popup_email" name="login_popup_email" placeholder="Email address"/></div>
      <div><input type="password" id="login_popup_password" name="login_popup_password" placeholder="Password"/></div>
      <div style="text-align: right">
         <input type="submit" class="submit_link" value="Log In &raquo;">
      </div>
      <div class="login_popup_form_links" style="font-size: smaller;">
         <div style="float:right">Need an account? <a href="/signup">Sign up!</a></div>
         <div><a href="/reset-password">Forgot your password?</a></div>
      </div>
   </form>
</div>
